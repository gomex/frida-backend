machine:
  environment:
    DATABASE_URL: "mongodb://localhost:27017:bdf_test"
    HEXO_SOURCE_PATH: "/tmp/source/"
    CERT_FILE_PATH: "./test/ssl/ssl.crt"
    KEY_FILE_PATH: "./test/ssl/ssl.key"
    HEXO_DEST_PATH: "/tmp/dest/"
  node:
    version: 4.4.4

dependencies:
  pre:
    - openssl aes-256-cbc -d -in frida-cipher -out frida-plain -k $KEY
    - chmod 400 frida-plain
  override:
    - npm cache clean
    - npm install

test:
  override:
    - npm test
    - npm run coverage || true

deployment:
  production:
    tag: production
    commands:
      - ./deploy_prod.sh
  staging:
    branch: master
    commands:
      - export DATABASE_URL="mongodb://localhost:27017/bdf"
      - export HEXO_SOURCE_PATH="/home/frida/hexo_source/"
      - export CERT_FILE_PATH="/etc/letsencrypt/live/cpmidias-teste.brasildefato.com.br/fullchain.pem"
      - export KEY_FILE_PATH="/etc/letsencrypt/live/cpmidias-teste.brasildefato.com.br/privkey.pem"
      - export HEXO_SITE_DEST="/www/site"
      - export HEXO_SITE_PATH="/home/frida/components/site"
      - export TOGGLE_6kDAA5TZ_AUTOMATIC_SERVICES="enabled"
      - export TOGGLE_qVIq5Tnp_INCREMENTAL_GEN="enabled"
      - ./config_env.sh
      - scp -i frida-plain .env frida@cpmidias-teste.brasildefato.com.br:/home/frida/components/frida-backend/
      - ssh -i frida-plain frida@cpmidias-teste.brasildefato.com.br -C "/home/frida/components/frida-scripts/deploy-frida-backend.sh $CIRCLE_SHA1"
